name: publish

on:
  workflow_call:
    inputs:
      snap-artifact:
        description: The snap artifact to be tested.
        required: true
        type: string
      snap-track:
        default: latest
        description: Snap Store channel track use for publication. Default to 'latest'.
        required: false
        type: string
    secrets:
      snapstore-login:
        description: Snap Store credential (see 'snapcraft export-login').
        required: false

jobs:
  publish:
    runs-on: ubuntu-latest
    steps:

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          name: ${{ inputs.snap-artifact }}
          path: .

      - name: Retrieve snap file
        id: get-snap-file
        run: echo "snap-file=$(find . -name '*.snap')" >> "$GITHUB_OUTPUT"

      - name: Publish snap
        uses: snapcore/action-publish@v1
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.snapstore-login }}
        if: env.SNAPCRAFT_STORE_CREDENTIALS
        with:
          snap: ${{ steps.get-snap-file.outputs.snap-file }}
          release: ${{ inputs.snap-track }}/${{ startsWith(github.ref, 'refs/tags/') && 'candidate' || 'edge'}}
