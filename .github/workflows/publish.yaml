name: publish

on:
  workflow_call:
    inputs:
      # snap-artifact:
      #   default: ''
      #   description: The snap artifact to be published.
      #   required: true
      #   type: string
      snap-track:
        default: latest
        description: Snap Store channel track use for publication.
        required: false
        type: string
    secrets:
      snapstore-login:
        description: Snap Store credential (see 'snapcraft export-login').
        required: true

jobs:
  prepare:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.prepare-matrix.outputs.matrix }}
    steps:

      - name: Check Snapstore login
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.snapstore-login }}
        run: |
          # Check if the key is empty
          if [ -z "${SNAPCRAFT_STORE_CREDENTIALS}" ]; then
            echo "Snapstore login is empty !"
            exit 1
          fi

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          # name: ${{ inputs.snap-artifact }}
          path: .

      - name: Retrieve snap file
        id: get-snap-files
        run: echo "snap-files=$(find . -name '*.snap')" >> "$GITHUB_OUTPUT"

      - name: prepare-matrix
        id: prepare-matrix
        uses: ./.github/actions/_jsonify.yaml
        with:
          input: ${{ steps.get-snap-files.outputs.snap-files }}

  publish:
    needs: [prepare]
    runs-on: ubuntu-latest
    strategy:
      matrix:
        snap: ${{ fromJson(needs.prepare.outputs.matrix) }}
    steps:

      - name: Check Snapstore login
        env:
          SNAPCRAFT_STORE_CREDENTIALS: ${{ secrets.snapstore-login }}
        run: |
          # Check if the key is empty
          if [ -z "${SNAPCRAFT_STORE_CREDENTIALS}" ]; then
            echo "Snapstore login is empty !"
            exit 1
          fi

      - name: Download snap artifact
        uses: actions/download-artifact@v4
        with:
          # name: ${{ inputs.snap-artifact }}
          path: .

      # - name: Retrieve snap file
      #   id: get-snap-file
      #   run: echo "snap-files=$(find . -name '*.snap')" >> "$GITHUB_OUTPUT"

      - name: Publish snap
        run: echo "Publishing'${{ matrix.snap }}'."

      # - name: Publish snap
      #   uses: snapcore/action-publish@v1
      #   with:
      #     snap: ${{ matrix.snap }}
      #     release: ${{ inputs.snap-track }}/${{ startsWith(github.ref, 'refs/tags/') && 'candidate' || 'edge'}}
